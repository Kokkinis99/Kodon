/**
 * Kodon Toast - Sonner-style animations for Angular.
 * Key principle: Use CSS transitions (not keyframes) for smooth interruption.
 * Transforms are applied to .kodon-toast-content (child) to avoid hover flicker.
 * @see https://emilkowal.ski/ui/building-a-toast-component
 */

@use './toast-visuals';

:host {
  // Customizable via CSS custom properties
  --kodon-toast-peek: 11px;
  --kodon-toast-padding: 14px 16px;
  --kodon-toast-border-radius: 10px;
  --kodon-toast-width: 355px;
  --kodon-toast-duration: 350ms;
  --kodon-toast-easing: cubic-bezier(0.165, 0.84, 0.44, 1); // ease-out-quart

  // Position within the container - let ng-primitives container handle fixed positioning
  position: absolute;
  bottom: 0;
  right: 0;
  z-index: var(--ngp-toast-z-index, 1);

  // Transition for when toasts beyond maxToasts become visible
  transition: opacity var(--kodon-toast-duration) var(--kodon-toast-easing);

  // Visibility for toasts beyond maxToasts
  &[data-visible='false'] {
    opacity: 0;
    pointer-events: none;
  }
}

// Animate transforms on the child to avoid hover flicker
.kodon-toast-content {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: var(--kodon-toast-padding);
  border-radius: var(--kodon-toast-border-radius);
  width: var(--kodon-toast-width, 355px);
  backdrop-filter: blur(8px);
  box-shadow:
    0 4px 12px rgba(0, 0, 0, 0.3),
    0 0 0 1px rgba(255, 255, 255, 0.05);

  will-change: transform, opacity;

  transition:
    transform var(--kodon-toast-duration) var(--kodon-toast-easing),
    opacity var(--kodon-toast-duration) var(--kodon-toast-easing),
    filter var(--kodon-toast-duration) var(--kodon-toast-easing);

  @media (prefers-reduced-motion: reduce) {
    transition: none;
  }
}

// Extend hover area to cover the gap between toasts when expanded
:host[data-front='false'][data-expanded='true'] .kodon-toast-content::after {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  top: 100%;
  height: var(--ngp-toast-gap, 14px);
}

// Front toast - default state
:host[data-front='true'] .kodon-toast-content {
  opacity: 1;
  transform: translateY(0);

  // Entry animation via @starting-style
  @starting-style {
    opacity: 0;
    transform: translateY(100%);
  }
}

// Stacking: Non-front toasts when collapsed
:host[data-front='false'][data-expanded='false'] {
  --stack-index: var(--ngp-toast-index, 1);
  --peek-offset: calc((var(--stack-index) - 1) * var(--kodon-toast-peek));
  --scale-factor: calc(1 - ((var(--stack-index) - 1) * 0.05));

  .kodon-toast-content {
    opacity: 1;
    transform:
      translateY(calc(var(--peek-offset) * -1))
      scale(var(--scale-factor));

    @starting-style {
      opacity: 0;
      transform: translateY(100%);
    }
  }
}

// When expanded (hover), show full stack
:host[data-front='false'][data-expanded='true'] .kodon-toast-content {
  opacity: 1;
  transform: translateY(calc(var(--ngp-toast-offset, 0) * -1)) scale(1);

  @starting-style {
    opacity: 0;
    transform: translateY(100%);
  }
}

// Swipe dismiss effect mixin - applies blur/fade based on swipe progress
@mixin swipe-dismiss-effect {
  // Convert pixel values to unitless for progress calculation
  --swipe-x: calc(var(--ngp-toast-swipe-amount-x, 0px) / 1px);
  --swipe-y: calc(var(--ngp-toast-swipe-amount-y, 0px) / 1px);

  // Get absolute values (works for negative swipes: left/up)
  --swipe-x-abs: max(var(--swipe-x), calc(var(--swipe-x) * -1));
  --swipe-y-abs: max(var(--swipe-y), calc(var(--swipe-y) * -1));

  // Normalize to progress (0 = at rest, 1 = fully dismissed)
  --swipe-progress-raw: calc(max(var(--swipe-x-abs), var(--swipe-y-abs)) / 200);
  --swipe-progress: clamp(0, calc((var(--swipe-progress-raw) - 0.1) / 0.9), 1);

  // Fade from 1 → 0.3 and blur from 0 → 4px as progress increases
  opacity: calc(1 - var(--swipe-progress) * 0.7);
  filter: blur(calc(var(--swipe-progress) * 4px));
}

// Swipe gesture support - front toast
:host[data-swiping='true'][data-front='true'] .kodon-toast-content {
  transition: none;
  transform:
    translateX(var(--ngp-toast-swipe-amount-x, 0))
    translateY(var(--ngp-toast-swipe-amount-y, 0));
  @include swipe-dismiss-effect;
}

// Swipe gesture support - non-front toasts (collapsed)
:host[data-swiping='true'][data-front='false'][data-expanded='false'] {
  --stack-index: var(--ngp-toast-index, 1);
  --peek-offset: calc((var(--stack-index) - 1) * var(--kodon-toast-peek));
  --scale-factor: calc(1 - ((var(--stack-index) - 1) * 0.05));

  .kodon-toast-content {
    transition: none;
    transform:
      translateX(var(--ngp-toast-swipe-amount-x, 0))
      translateY(calc(var(--ngp-toast-swipe-amount-y, 0) - var(--peek-offset)))
      scale(var(--scale-factor));
    @include swipe-dismiss-effect;
  }
}

// Swipe gesture support - non-front toasts (expanded)
:host[data-swiping='true'][data-front='false'][data-expanded='true'] .kodon-toast-content {
  transition: none;
  transform:
    translateX(var(--ngp-toast-swipe-amount-x, 0))
    translateY(calc(var(--ngp-toast-swipe-amount-y, 0) - var(--ngp-toast-offset, 0)));
  @include swipe-dismiss-effect;
}
